# Binary sensor that tracks whether anyone is home.
- triggers:
    # Trigger on known household members coming and going.
    - trigger: zone
      entity_id:
        - person.scotty
      zone: zone.home
      event: enter
    - trigger: zone
      entity_id:
        - person.scotty
      zone: zone.home
      event: leave
      id: "left_home"

    # Trigger on occupancy sensors.
    - trigger: state
      entity_id: binary_sensor.home_occupancy
      to:
        - "on"
        - "off"

  binary_sensor:
    - name: "Anyone Home"
      unique_id: anyone_home
      device_class: "occupancy"
      state: |
        {% if state_attr('zone.home', 'persons') %}
          {# Household member is at home #}
          on
        {% elif trigger.id == 'left_home' %}
          {# Last household member left home, if door is locked, then go
             go straight to unoccupied, otherwise home_occupancy is sticky #}
          {% if is_state('lock.front_door', 'locked') %}
            off
          {% else %}
            {{ states('binary_sensor.home_occupancy') }}
          {% endif %}
        {% elif is_state('binary_sensor.doors_opened_while_not_occupied', 'on') %}
          {# Door has been opened #}
          {{ states('binary_sensor.home_occupancy') }}
        {% else %}
          off
        {% endif %}
      attributes:
        door_opened: "{{ states('binary_sensor.doors_opened_while_not_occupied') }}"
        entity_id: |
          {{ [  'binary_sensor.home_occupancy',
                'binary_sensor.doors_opened_while_not_occupied',
                'lock.front_door',
                'zone.home' ] }}
        locked: "{{ states('lock.front_door') }}"
        occupancy: "{{ states('binary_sensor.home_occupancy') }}"
        persons: "{{ state_attr('zone.home', 'persons') }}"
